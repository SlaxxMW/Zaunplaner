<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Zaunteam Zaunplaner</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#e6e6e6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="./icon-192.png">

    <link rel="stylesheet" href="./styles.css?v=1.4.53">

</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="toprow">
        <div class="row">
          <div class="brand">Zaunteam Zaunplaner <small id="verPill" class="pill accent">vâ€”</small></div>
          <span class="pill" id="statusPill">kein Projekt</span>
          <span class="pill" id="savePill">gespeichert: â€”</span>
          <span class="pill" id="backupPill">Backup: â€”</span>
          <span class="pill" id="projCountPill">0</span>
        </div>
        <div class="row">
          <button class="btn" id="btnBackup" type="button" title="Erzeugt eine Sicherungsdatei mit allen Kunden & Daten">ğŸ’¾ Speichern (Datei)</button>
          <button class="btn small" id="btnDemo" type="button">Demo</button>
      <button id="btnImportJson" class="btn" type="button" title="LÃ¤dt eine Sicherungsdatei (JSON) wieder ein">ğŸ“‚ Laden (Datei)</button>
      <input id="fileImportJson" type="file" accept="application/json,.json" style="display:none" />
          <button class="btn small" id="btnCSV" type="button">Material CSV</button>
          <button id="btnUpdate" class="btn" type="button">Update prÃ¼fen</button>
      <button class="btn small bad" id="btnReset" type="button">Reset</button>
        </div>
      </div>

      <div class="tabs">
        <button class="tabBtn active" data-tab="kunde" type="button">ğŸ‘¤ Kunde / Projekt</button>
        <button class="tabBtn" data-tab="chef" type="button">ğŸ› ï¸ Chef/Team</button>
        <button class="tabBtn" data-tab="settings" type="button">âš™ï¸ Einstellungen</button>
      </div>
    </div>

    <!-- KUNDE/PROJEKT (vereint) -->
    <section class="panel tab" data-tab="kunde">
      <div class="cardTitle">
        <h2>ğŸ‘¤ Kunden</h2>
        <span class="pill" id="projCountPill">0</span>
      </div>

      <!-- LIST VIEW -->
      <div id="kundenListView">
        <div class="card">
        <div class="row" style="margin-top:6px;">
          <div style="flex:1;">
            <label>Suche Kunde</label>
            <input id="projSearch" placeholder="z.B. MÃ¼ller, MusterstraÃŸeâ€¦" />
          </div>
        </div>

        <details id="projOverviewDetails" style="margin-top:10px;">
          <summary style="cursor:pointer; user-select:none;">ğŸ“‹ ProjektÃ¼bersicht (Status / Stunden)</summary>
          <div id="projOverview" style="margin-top:8px;"></div>
        </details>

          <div class="row">
            <div style="flex:1;">
              <label>Kunde auswÃ¤hlen</label>
              <select id="projSel"></select>
            </div>
            <div style="display:flex; gap:8px; align-items:flex-end;">
              <button id="btnOpenCustomer" class="btn green" type="button">Ã–ffnen</button>
              <button id="btnAdd" class="btn dark" type="button">+ Neuer Kunde</button>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div style="flex:1;">
              <label>Kundenname (fÃ¼r Neu)</label>
              <input id="pName" placeholder="Neuer Kunde" />
            </div>
          </div>

          <details style="margin-top:10px;">
            <summary style="cursor:pointer; font-weight:900;">Optionale Basisdaten (bei Neu)</summary>
            <div class="row" style="margin-top:10px;">
              <div style="flex:1;">
                <label>Erstellt (optional)</label>
                <input id="pCreated" type="date" />
              </div>
              <div style="flex:1;">
                <label>AusfÃ¼hrung (optional)</label>
                <input id="pDate" type="date" />
              </div>
            </div>
            <div class="row" style="margin-top:10px;">
              <div style="flex:1;">
                <label>Telefon (optional)</label>
                <input id="pPhone" placeholder="+49..." />
              </div>
              <div style="flex:1;">
                <label>Eâ€‘Mail (optional)</label>
                <input id="pEmail" placeholder="mail@..." />
              </div>
            </div>
            <div class="row" style="margin-top:10px;">
              <div style="flex:1;">
                <label>Adresse Kunde (optional)</label>
                <input id="pAddr" placeholder="StraÃŸe, PLZ Ort" />
              </div>
              <div style="flex:1;">
                <label>Objektadresse (optional)</label>
                <input id="pObj" placeholder="falls abweichend" />
              </div>
            </div>
          </details>

          <div class="hint" style="margin-top:10px;">
            Tipp: WÃ¤hle einen Kunden im Dropdown â†’ â€Ã–ffnenâ€œ. Im Bearbeitenâ€‘Modus wird automatisch gespeichert.
          </div>
        </div>

        <div id="projCards" style="display:none;"></div>
      </div>

      <!-- EDIT VIEW -->
      <div id="kundenEditView" style="display:none;">
        <div class="row" style="margin-bottom:10px;">
          <button id="btnBackToList" class="btn blue" type="button">â† ZurÃ¼ck zur Kundenliste</button>
        </div>


      <div class="cardTitle">
        <h2 id="kundeTitle">ğŸ‘¤ Kunde</h2>
        <span class="pill" id="kundePill">leer</span>
      </div>
      <div id="kundeKpi" class="row" style="margin-top:8px;"></div>
      <div class="card" style="margin-top:10px;">
        <div class="cardTitle"><h3>ğŸ  Adresse Kunde</h3></div>
        <div class="grid3">
          <div style="grid-column: span 2;">
            <label>StraÃŸe / Hausnr.</label>
            <input id="kStreet" placeholder="z.B. HauptstraÃŸe 12" />
          </div>
          <div>
            <label>PLZ</label>
            <input id="kZip" inputmode="numeric" placeholder="z.B. 10115" />
            <div class="hint">Ort wird online automatisch ergÃ¤nzt (sonst manuell).</div>
          </div>
          <div style="grid-column: span 2;">
            <label>Ort</label>
            <input id="kCity" placeholder="z.B. Berlin" />
          </div>
          <div>
            <label>Land (optional)</label>
            <input id="kCountry" placeholder="DE" />
          </div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div style="flex:1;">
            <label>Objektadresse / Baustelle (optional)</label>
            <input id="kObjAddr" placeholder="falls abweichend" />
          </div>
        </div>
        <div class="hint" id="addrBar" style="margin-top:8px;">Adresse: â€”</div>
      </div>


      <div class="grid3">
        
        <div>
          <label>Erstellt</label>
          <input id="kCreated" type="date" />
        </div>
        <div>
          <label>AusfÃ¼hrung</label>
          <input id="kPlanned" type="date" />
        </div>
        <div>
          <label>Telefon</label>
          <input id="kPhone" inputmode="tel" />
        </div>
      </div>

      <div class="cardTitle" style="margin-top:8px;"><h3>ğŸ“‡ Kontakt</h3></div>
      <div class="grid2">
        <div>
          <label>Eâ€‘Mail</label>
          <input id="kEmail" inputmode="email" />
        </div>
        <div style="opacity:.65; font-size:12px; padding-top:26px;">Zaun wird Ã¼ber Abschnitte erfasst (A, B, Câ€¦)</div>
      </div>
      <input id="kLen" type="hidden" />

      <div id="customerFenceGlobalsTop" style="display:none;">
  <div class="grid3">
    <div>
      <label>HÃ¶he</label>
      <select id="kHeight"></select>
    </div>
    <div>
      <label>System</label>
      <select id="kSystem">
        <option>Doppelstab</option>
        <option>Holz</option>
        <option>WPC</option>
        <option>Aluminium</option>
        <option>Diagonalgeflecht</option>
        <option>Tornado</option>
        <option>Elektrozaun</option>
      </select>
    </div>
    <div>
      <label>Farbe</label>
      <select id="kColor"></select>
    </div>
  </div>
</div>

<div id="customerFenceGlobalsBottom" style="display:none;">
  <div class="grid2">
    <div>
      <label>Holzart</label>
      <select id="kWood"></select>
    </div>
    <div>
      <label>WPC Variante</label>
      <select id="kWpc"></select>
    </div>
  </div>
</div>

<div class="grid3" style="margin-top:10px;">
  <div>
    <label>GefÃ¤lle</label>
    <select id="kSlopeType">
      <option value="flat">kein</option>
      <option value="pct">%</option>
    </select>
  </div>

  <div class="card fullBleed" style="margin-top:0; grid-column:1 / -1;">
    <div class="cardTitle">
      <h3>ğŸ§© Zaunabschnitte (A, B, Câ€¦)</h3>
      <span class="pill">unterschiedliche HÃ¶hen & Systeme</span>
    </div>

    <div class="row" style="margin-top:8px; gap:8px; align-items:flex-end;">
      <div style="flex:0 0 140px;">
        <label>Neu</label>
        <select id="segAddLabel"></select>
      </div>
      <button id="btnSegAdd" class="btn green" type="button">+ Abschnitt</button>
      <button id="btnSegCollapseAll" class="btn" type="button">Alle schlieÃŸen</button>
      <button id="btnSegExpandAll" class="btn" type="button">Alle Ã¶ffnen</button>
    </div>

    <div id="segList" style="margin-top:10px;"></div>

    <div class="hint" style="margin-top:10px;">
      Tipp: LÃ¤nge je Abschnitt eintragen. GesamtlÃ¤nge wird automatisch summiert.
    </div>
  </div>

  <div>
    <label>GefÃ¤lle %</label>
    <input id="kSlopePct" inputmode="decimal" placeholder="z. B. 2,5" />
  </div>
</div>

<!-- Eck-/Corner Eingabe auÃŸerhalb der Abschnitte (ausgeblendet, bleibt fÃ¼r KompatibilitÃ¤t) -->
<div style="display:none;">
  <label>Ecken</label>
  <div class="row">
    <button class="btn small" id="kCornersMinus" type="button">âˆ’</button>
    <input id="kCorners" inputmode="numeric" value="0" style="max-width:140px;" />
    <button class="btn small" id="kCornersPlus" type="button">+</button>
  </div>
</div>

<div class="grid2">
        <div>
          <label>Betonâ€‘Modus</label>
          <select id="kConcreteMode">
            <option value="sacks">Sack (Auto)</option>
            <option value="m3">mÂ³ (Auto)</option>
          </select>
          <div class="hint" id="kConcreteAutoHint" style="margin-top:6px;"></div>
        </div>
        <div>
          <label>Beton (Auto)</label>
          <input id="kConcreteVal" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Sichtschutz?</label>
          <select id="kPrivacy">
            <option value="no">nein</option>
            <option value="yes">ja</option>
          </select>
        </div>
        <div>
          <label>Sichtschutzâ€‘LÃ¤nge (m)</label>
          <input id="kPrivacyLen" inputmode="decimal" placeholder="leer = ganze ZaunlÃ¤nge" />
        </div>
      </div>
      <div class="grid2" id="privacyRollRow" style="margin-top:10px;">
        <div>
          <label>Rollenâ€‘LÃ¤nge</label>
          <select id="kPrivacyRoll">
            <option value="35">35 m</option>
            <option value="50">50 m</option>
          </select>
        </div>
        <div>
          <label>Sichtschutzâ€‘Rollen (Auto)</label>
          <input id="kPrivacyRollsAuto" disabled />
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="grid2">
          <div>
            <label>Torâ€‘Typ</label>
            <select id="kGateType">
              <option value="none">kein Tor</option>
              <option value="gate1">1â€‘flÃ¼gelig</option>
              <option value="gate2">2â€‘flÃ¼gelig</option>
              <option value="gate3">3â€‘flÃ¼gelig</option>
            </select>
          </div>
          <div class="row" style="align-self:end;">
            <button class="btn small" id="btnGateAdd" type="button">+ Tor</button>
            <button class="btn small bad" id="btnGateClear" type="button">Tore lÃ¶schen</button>
          </div>
        </div>
        <div id="gateVariants" class="hint" style="margin-top:10px;"></div>
        <div id="gateRows" style="margin-top:10px;"></div>
      </div>

      <label>Kundenâ€‘Notiz</label>
      <textarea id="kNote" placeholder="Notizenâ€¦"></textarea>

      
</div>
<div class="row" style="margin-top:10px;">
<button class="btn blue" id="btnKDown" type="button">Kundenâ€‘Text Download</button>
        <button class="btn accent green" id="btnKWhats" type="button">WhatsApp Kunde</button>
        <button class="btn orange" id="btnKCall" type="button">ğŸ“</button>
        <button class="btn purple" id="btnKMail" type="button">âœ‰ï¸</button>
      </div>
    
      </div>
    </section>

    <!-- CHEF / TEAM -->
    <section class="panel tab" data-tab="chef" style="display:none;">
      <div class="cardTitle">
        <h2 id="chefTitle">ğŸ› ï¸ Chef / Team</h2>
        <span class="pill" id="chefPill">leer</span>
      </div>

      <div class="grid3">
        <div>
          <label>Bagger</label>
          <select id="cBagger">
            <option value="no">nein</option>
            <option value="yes">ja</option>
          </select>
        </div>
        <div>
          <label>Ramme</label>
          <select id="cRamme">
            <option value="no">nein</option>
            <option value="yes">ja</option>
          </select>
        </div>
        <div>
          <label>HÃ¤nger</label>
          <select id="cHaenger">
            <option value="no">nein</option>
            <option value="yes">ja</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>HandbohrgerÃ¤t</label>
          <select id="cHandbohr">
            <option value="no">nein</option>
            <option value="yes">ja</option>
          </select>
        </div>
        <div>
          <label>Schubkarre</label>
          <select id="cSchubkarre">
            <option value="no">nein</option>
            <option value="yes">ja</option>
          </select>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label>Geplante Stunden</label>
          <input id="cHoursPlanned" inputmode="decimal" placeholder="z.B. 16" />
        </div>
        <div>
          <label>Status (optional)</label>
          <select id="cStatus">
            <option value="draft">Entwurf</option>
            <option value="planned">geplant</option>
            <option value="inwork">in Arbeit</option>
            <option value="done">fertig</option>
          </select>
        </div>
      </div>

      <label>Kundenâ€‘Notiz (automatisch)</label>
      <textarea id="cCustomerNote" readonly placeholder="(wird aus dem Kundenâ€‘Tab Ã¼bernommen)"></textarea>

      <label>Teamâ€‘Hinweise</label>
      <textarea id="cNote" placeholder="z. B. Zufahrt, Besonderheitenâ€¦"></textarea>

      <div class="card">
        <div class="cardTitle">
          <b>Interne Materialliste</b>
          <span class="pill" id="matPill">0</span>
        </div>

        <div class="grid3" style="margin-top:10px;">
          <div>
            <label>Material</label>
            <select id="mName">
              <optgroup label="Matten / Elemente">
                <option>Doppelstabmatte</option>
                <option>Diagonalgeflecht</option>
                <option>Tornado</option>
                <option>Elektrozaun</option>
              </optgroup>
              <optgroup label="Pfosten">
                <option>Pfosten</option>
                <option>Eckpfosten</option>
              </optgroup>
              <optgroup label="Leisten / ZubehÃ¶r">
                <option>U-Leiste</option>
                <option>Torleiste</option>
                <option>Abdeckkappe</option>
              </optgroup>
              <optgroup label="Beton">
                <option>Beton (Sack)</option>
                <option>Fertigbeton (mÂ³)</option>
              </optgroup>
              <optgroup label="Sonstiges">
                <option value="__custom__">Sonstiges (Freitext)â€¦</option>
              </optgroup>
            </select>
            <input id="mNameCustom" placeholder="Material frei eingebenâ€¦" style="display:none; margin-top:8px;" />
          </div>
          <div>
            <label>Menge</label>
            <input id="mQty" inputmode="decimal" />
          </div>
          <div>
            <label>Einheit</label>
            <select id="mUnit">
              <option>Stk</option>
              <option>m</option>
              <option>mÂ²</option>
              <option>Sack</option>
              <option>mÂ³</option>
              <option>Paket</option>
            </select>
          </div>
        </div>
<div class="row" style="margin-top:10px;">
          <button class="btn good" id="btnAddMat" type="button">+ hinzufÃ¼gen</button>
          <button class="btn bad" id="btnClearMat" type="button">Liste leeren</button>
        </div>

        <div id="matList" style="margin-top:10px;"></div>
      </div>

      <div class="card">
        <div class="cardTitle">
          <b>Fotos</b>
          <span class="pill" id="photoPill">0</span>
        </div>
        <div class="hint" style="margin:8px 0 10px;">
          Desktopâ€‘WhatsApp kann Fotos nicht automatisch anhÃ¤ngen â†’ nutze â€Fotos.zipâ€œ.
        </div>
        <div id="photoGrid"></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn accent green" id="btnCWhatsText" type="button">Intern Text</button>
        <button class="btn accent green" id="btnCWhatsFotos" type="button">Intern Fotos</button>
        <button class="btn accent green" id="btnCWhats" type="button">Intern Alles</button>
        <button class="btn accent" id="btnCMaps" type="button">ğŸ“ Maps</button>
        <button class="btn blue" id="btnCDown" type="button">Internâ€‘Text Download</button>
        <button class="btn blue" id="btnCZip" type="button">Fotos.zip</button>
        <button class="btn purple" id="btnCMail" type="button">Eâ€‘Mail (Text)</button>
      </div>
    </section>

    <!-- SETTINGS -->
    <section class="panel tab" data-tab="settings" style="display:none;">
      <h2>âš™ï¸ Einstellungen & Backup</h2>

      <div class="card">
        <div class="cardTitle">
          <b>Speicherâ€‘Status</b>
          <span class="pill" id="storagePill">â€”</span>
        </div>
        <div id="storageStatusBox" class="hint" style="margin-top:10px;"></div>
        <div class="row" style="margin-top:10px;">
          <button class="btn small" id="btnStorageSelfTest" type="button">ğŸ”§ Speicher testen</button>
          <button class="btn small" id="btnExportLog" type="button">ğŸ§¾ Log exportieren</button>
        </div>
      </div>

      <div class="card">
        <div class="cardTitle"><b>Backup & Restore</b></div>
        <div class="hint" style="margin-top:6px;">
          VollstÃ¤ndig offline. Export passiert nur manuell. Import bietet <b>Merge</b> oder <b>Replace</b> + Report.
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn green" id="btnExportJSON" type="button">ğŸ’¾ JSON Backup</button>
          <button class="btn" id="btnImportJSON2" type="button">ğŸ“‚ JSON importieren</button>
          <button class="btn blue" id="btnExportCSVProjects" type="button">ğŸ“„ CSV Kunden</button>
          <button class="btn blue" id="btnExportCSVAllMaterials" type="button">ğŸ“„ CSV Gesamtâ€‘Material</button>
          <button class="btn purple" id="btnExportPDF" type="button">ğŸ–¨ï¸ PDF Report (Druck)</button>
        </div>
        <div class="hint" style="margin-top:8px;">
          Mobile: Wenn mÃ¶glich Ã¶ffnet sich direkt das Teilenâ€‘MenÃ¼. Dateiname enthÃ¤lt Datum/Uhrzeit.
        </div>
      </div>

      <div class="card">
        <div class="cardTitle"><b>Exportâ€‘Optionen</b></div>
        <div class="grid2" style="margin-top:10px;">
          <div>
            <label><input id="setShareOnExport" type="checkbox" style="width:auto; margin-right:8px;" />Beim Export Teilenâ€‘MenÃ¼ nutzen (wenn verfÃ¼gbar)</label>
            <div class="hint">Empfohlen fÃ¼r iPhone/Android. Fallback ist normaler Download.</div>
          </div>
          <div>
            <label><input id="setAutoBackupHint" type="checkbox" style="width:auto; margin-right:8px;" disabled />Erinnerung â€Backup machenâ€œ (spÃ¤ter)</label>
            <div class="hint">Vorbereitet â€“ ohne Zwang & ohne Benachrichtigungen (noch deaktiviert).</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardTitle"><b>Datenschutz</b></div>
        <div class="hint" style="margin-top:6px;">
          <b>Keine Accounts, kein Tracking, keine Werbung.</b><br>
          Alle Daten bleiben lokal auf deinem GerÃ¤t (Browserâ€‘Speicher).<br>
          Export/Teilen passiert nur, wenn du aktiv auf â€Exportâ€œ klickst.
        </div>
      </div>

      <div class="card">
        <div class="cardTitle"><b>Support</b></div>
        <div class="grid2" style="margin-top:10px;">
          <div>
            <label>Kontaktâ€‘Mail</label>
            <input id="setSupportEmail" placeholder="z.B. info@deinbetrieb.de" />
          </div>
          <div>
            <label>Appâ€‘Info</label>
            <div id="supportInfo" class="hint" style="margin-top:6px;"></div>
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn small" id="btnSupportMail" type="button">âœ‰ï¸ Supportâ€‘Mail Ã¶ffnen</button>
        </div>
      </div>
    </section>

  </div>

  <div id="updateBar" style="display:none; margin-top:10px;" class="card">
    <div class="row" style="align-items:center; justify-content:space-between;">
      <div style="font-weight:900;">ğŸ”„ Update verfÃ¼gbar â€“ jetzt neu laden?</div>
      <button id="btnUpdateNow" class="btn green" type="button">Jetzt aktualisieren</button>
    </div>
    <div class="hint" style="margin-top:8px;">Hinweis: Deine Kunden bleiben erhalten.</div>
  </div>

  <div id="modalHost" class="modalHost"><div class="modalCard" id="modalCard"></div></div>

  <div id="toast"></div>

  <datalist id="gateWidthList">
    <option value="80"></option>
    <option value="100"></option>
    <option value="125"></option>
    <option value="150"></option>
    <option value="200"></option>
  </datalist>

  <script src="./src/catalog.js?v=1.4.53" defer></script>
  <script src="./app.js?v=1.4.53" defer></script>
  <!-- PWA Service Worker (Auto-Update, offline-ready) -->
  <script>
    (function(){
      const VER = "1.4.53";
      if (!('serviceWorker' in navigator)) return;
      window.addEventListener('load', async () => {
        const updateBar = document.getElementById('updateBar');
        const btnUpdateNow = document.getElementById('btnUpdateNow');
        const showUpdate = () => { if(updateBar) updateBar.style.display = 'block'; };
        try{
          // Cleanup: alte Versionen raus
          try{
            const regs = await navigator.serviceWorker.getRegistrations();
            for(const r of regs){
              const u = (r && r.active && r.active.scriptURL) ? r.active.scriptURL : '';
              if(u.includes('sw.js?v=') && !u.includes('sw.js?v='+VER)) await r.unregister();
            }
          }catch(_){ }

          const reg = await navigator.serviceWorker.register('./sw.js?v='+VER, { updateViaCache: 'none' });
          const doUpdate = () => reg && reg.update().catch(()=>{});
          doUpdate();
          setInterval(doUpdate, 10*60*1000);

          if(reg.waiting) showUpdate();
          reg.addEventListener('updatefound', () => {
            const sw = reg.installing;
            if(!sw) return;
            sw.addEventListener('statechange', () => {
              if(sw.state==='installed' && navigator.serviceWorker.controller) showUpdate();
            });
          });

          if(btnUpdateNow){
            btnUpdateNow.addEventListener('click', () => {
              try{ if(reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'}); }catch(_){ }
              setTimeout(()=>location.reload(), 200);
            });
          }

          navigator.serviceWorker.addEventListener('controllerchange', () => location.reload());
        }catch(e){
          console.warn('SW register failed', e);
        }
      });
    })();
  </script>
</body>
</html>
