<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<title>Zaunteam Zaunplaner v1.4</title>
<style>
  :root{
    --bg:#0b0b0c; --panel:#121214; --text:#f3f0e8; --muted:#b9b1a2;
    --gold:#d7b56d; --line:#2a2520; --good:#1fbf75; --bad:#ff4d4d;
  }
  *{box-sizing:border-box;}
  body{margin:0;background:radial-gradient(1200px 900px at 30% -10%, #2a2318 0%, rgba(0,0,0,0) 60%), var(--bg);
    color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{max-width:980px;margin:0 auto;padding:14px 12px 80px;}
  .top{display:flex;gap:10px;align-items:center;justify-content:space-between;}
  .brand h1{margin:0;font-size:18px;letter-spacing:.3px;}
  .sub{font-size:12px;color:var(--muted);}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;
    background:rgba(255,255,255,.03);font-size:12px;color:var(--muted);}
  .pill.good{border-color:rgba(31,191,117,.35);color:#dff7ea;}
  .tabs{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;}
  .tabBtn{border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--text);padding:10px 12px;border-radius:14px;
    font-weight:650;font-size:13px;cursor:pointer;}
  .tabBtn.active{border-color:rgba(215,181,109,.65);box-shadow:0 0 0 2px rgba(215,181,109,.15) inset;}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));border:1px solid var(--line);
    border-radius:18px;padding:12px;margin-top:12px;}
  details{background:transparent;}
  summary{list-style:none;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:10px;}
  summary::-webkit-details-marker{display:none;}
  .sep{height:1px;background:linear-gradient(90deg, rgba(215,181,109,.0), rgba(215,181,109,.35), rgba(215,181,109,.0));margin:10px 0;}
  label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px;}
  input,select,textarea{width:100%;background:rgba(0,0,0,.35);border:1px solid var(--line);color:var(--text);
    border-radius:14px;padding:10px 12px;font-size:14px;outline:none;}
  textarea{min-height:84px;resize:vertical;}
  input:focus,select:focus,textarea:focus{border-color:rgba(215,181,109,.7);box-shadow:0 0 0 2px rgba(215,181,109,.12);}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
  @media(max-width:720px){.grid2,.grid3{grid-template-columns:1fr;}}
  .row{display:flex;gap:10px;align-items:center;}
  .tight{gap:8px;}
  .btn{border:1px solid var(--line);background:rgba(255,255,255,.05);color:var(--text);padding:10px 12px;border-radius:14px;font-weight:700;cursor:pointer;}
  .btn.small{padding:8px 10px;border-radius:12px;font-size:13px;}
  .btn.primary{border-color:rgba(215,181,109,.75);background:linear-gradient(180deg, rgba(215,181,109,.18), rgba(215,181,109,.08));}
  .btn.good{border-color:rgba(31,191,117,.55);}
  .btn.bad{border-color:rgba(255,77,77,.55);}
  .btnbar{display:flex;gap:10px;flex-wrap:wrap;}
  .hint{color:var(--muted);font-size:12px;line-height:1.35;}
  .cards{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
  @media(max-width:720px){.cards{grid-template-columns:1fr;}}
  .card{background:rgba(0,0,0,.25);border:1px solid var(--line);border-radius:16px;padding:12px;cursor:pointer;}
  .card:hover{border-color:rgba(215,181,109,.45);}
  .cardTitle{display:flex;align-items:center;justify-content:space-between;gap:10px;}
  .cardTitle b{font-size:14px;}
  .meta{color:var(--muted);font-size:12px;margin-top:4px;}
  .kpi{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
  .kpi .pill b{color:var(--gold);}
  .stepper{display:flex;gap:8px;align-items:center;}
  .stepper input{text-align:center;}
  .photoGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
  @media(max-width:720px){.photoGrid{grid-template-columns:1fr;}}
  .ph{border:1px dashed rgba(215,181,109,.45);border-radius:16px;padding:10px;background:rgba(0,0,0,.25);}
  .ph img{width:100%;border-radius:12px;display:block;}
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(0,0,0,.7);
    border:1px solid rgba(215,181,109,.4);color:var(--text);padding:10px 12px;border-radius:14px;max-width:92vw;z-index:9999;}
  .gold{color:var(--gold);}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <h1>Zaunteam Zaunplaner <span class="gold">v1.4</span></h1>
      <div class="sub">Projekte ‚Ä¢ Kunden√ºbersicht (WhatsApp) ‚Ä¢ Chef/Team‚ÄëDokumentation ‚Ä¢ Offline‚Äëf√§hig</div>
    </div>
    <div class="pill" id="statusPill">bereit</div>
  </div>

  <div class="panel">
    <details open id="projDetails">
      <summary>
        <span>üìÅ Projekte</span>
        <span class="pill" id="projCountPill">0</span>
      </summary>
      <div class="sep"></div>

      <div class="grid3">
        <div>
          <label>Projektname (Kunde)</label>
          <input id="pName" placeholder="z.B. Kunde M√ºller"/>
        </div>
        <div>
          <label>Ausf√ºhrung (Datum)</label>
          <input id="pDate" type="date"/>
        </div>
        <div>
          <label>Telefon</label>
          <input id="pPhone" inputmode="tel" placeholder="+49 ..."/>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label>Adresse Kunde</label>
          <input id="pAddr" placeholder="Stra√üe, PLZ Ort"/>
        </div>
        <div>
          <label>Objektadresse (falls abweichend)</label>
          <input id="pObj" placeholder="Stra√üe, PLZ Ort"/>
        </div>
      </div>

      <div class="btnbar" style="margin-top:10px;">
        <button class="btn primary" id="btnAdd">‚ûï Projekt anlegen</button>
        <button class="btn" id="btnDup">üìÑ Duplizieren</button>
        <button class="btn bad" id="btnDel">üóëÔ∏è L√∂schen</button>
      </div>

      <div class="sep"></div>

      <div class="grid2">
        <div>
          <label>Sortierung</label>
          <select id="sortSel">
            <option value="name">Name (A‚ÄëZ)</option>
            <option value="date">Ausf√ºhrungsdatum</option>
            <option value="created">Erstellungsdatum</option>
          </select>
        </div>
        <div>
          <label>Projekt ausw√§hlen</label>
          <select id="projSel"></select>
        </div>
      </div>

      <div class="cards" id="projCards"></div>
      <div class="hint" style="margin-top:10px;">Karte antippen ‚Üí √∂ffnet Kunde. Alle Daten bleiben beim Update erhalten (Migration v1.1‚Äìv1.3).</div>
    </details>
  </div>

  <div class="tabs">
    <button class="tabBtn active" data-tab="kunde">üë§ Kunde</button>
    <button class="tabBtn" data-tab="chef">üõ†Ô∏è Chef / Team</button>
    <button class="tabBtn" data-tab="backup">üíæ Backup</button>
  </div>

  <div class="panel tab" data-tab="kunde">
    <details open id="kundeCard">
      <summary>
        <span id="kundeTitle">üë§ Kunde</span>
        <span class="pill" id="kundePill">leer</span>
      </summary>
      <div class="sep"></div>

      <div class="grid2">
        <div>
          <label>Zaunl√§nge gesamt (m)</label>
          <input id="kLen" inputmode="decimal" placeholder="z.B. 18"/>
        </div>
        <div>
          <label>H√∂he</label>
          <select id="kHeight"></select>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label>System</label>
          <select id="kSystem">
            <option>Doppelstab</option>
            <option>Aluminium</option>
            <option>Holz</option>
            <option>WPC</option>
          </select>
        </div>
        <div>
          <label>Farbe</label>
          <select id="kColor"></select>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label>Holzart (nur bei Holz)</label>
          <select id="kWood"></select>
        </div>
        <div>
          <label>WPC‚ÄëVariante (nur bei WPC)</label>
          <select id="kWpc"></select>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label>Gel√§nde</label>
          <select id="kSlopeType">
            <option value="flat">gerade</option>
            <option value="slope">absch√ºssig</option>
            <option value="hang">am Hang</option>
            <option value="steep">steil</option>
          </select>
        </div>
        <div>
          <label>Neigung % (optional)</label>
          <input id="kSlopePct" inputmode="decimal" placeholder="z.B. 12"/>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label>Ecken (Anzahl)</label>
          <div class="stepper">
            <button class="btn small" id="kCornersMinus" type="button">‚àí</button>
            <input id="kCorners" inputmode="numeric" value="0"/>
            <button class="btn small" id="kCornersPlus" type="button">+</button>
          </div>
        </div>
        <div>
          <label>Beton</label>
          <div class="row tight">
            <select id="kConcreteMode" style="flex:1;">
              <option value="sacks">S√§cke</option>
              <option value="m3">m¬≥</option>
            </select>
            <input id="kConcreteVal" inputmode="decimal" placeholder="z.B. 18" style="flex:1;"/>
          </div>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>Notiz (optional)</label>
        <textarea id="kNote" placeholder="z.B. Besonderheiten / W√ºnsche‚Ä¶"></textarea>
      </div>

      <div class="kpi" id="kundeKpi"></div>

      <div class="sep"></div>
      <div class="btnbar">
        <button class="btn primary" id="btnKCalc">‚úÖ Berechnen & √ºbernehmen</button>
        <button class="btn good" id="btnKWhats">üì≤ WhatsApp‚ÄëText (Kunde)</button>
        <button class="btn" id="btnKDown">‚¨áÔ∏è Download Kunde.txt</button>
      </div>

      <div class="hint" style="margin-top:10px;">WhatsApp‚ÄëText ist sauber: Liste untereinander, keine leeren Felder.</div>
    </details>
  </div>

  <div class="panel tab" data-tab="chef" style="display:none;">
    <details open id="chefCard">
      <summary>
        <span id="chefTitle">üõ†Ô∏è Chef / Team</span>
        <span class="pill" id="chefPill">leer</span>
      </summary>
      <div class="sep"></div>

      <div class="grid3">
        <div><label>Bagger</label><select id="cBagger"><option value="no">nein</option><option value="yes">ja</option></select></div>
        <div><label>Ramme</label><select id="cRamme"><option value="no">nein</option><option value="yes">ja</option></select></div>
        <div><label>H√§nger</label><select id="cHaenger"><option value="no">nein</option><option value="yes">ja</option></select></div>
      </div>

      <div style="margin-top:10px;">
        <label>Interne Notiz / Baustellenhinweise</label>
        <textarea id="cNote" placeholder="Zugang, Parken, Fundament, Lieferhinweise‚Ä¶"></textarea>
      </div>

      <div class="sep"></div>

      <details open>
        <summary><span>üßæ Interne Materialliste (Team)</span><span class="pill" id="matPill">0</span></summary>
        <div class="sep"></div>

        <div class="grid2">
          <div>
            <label>Material</label>
            <input id="mName" placeholder="z.B. Pfosten 60x40"/>
          </div>
          <div>
            <label>Menge</label>
            <div class="row tight">
              <input id="mQty" inputmode="decimal" placeholder="z.B. 12" style="flex:1;"/>
              <select id="mUnit" style="flex:1;">
                <option>Stk</option><option>m</option><option>m¬≤</option><option>Sack</option><option>m¬≥</option><option>Paket</option>
              </select>
            </div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>Notiz (grob, optional)</label>
          <textarea id="mNote" placeholder="Freitext / kurze √úbersicht‚Ä¶"></textarea>
        </div>

        <div class="btnbar" style="margin-top:10px;">
          <button class="btn primary" id="btnAddMat">‚ûï Hinzuf√ºgen</button>
          <button class="btn" id="btnClearMat">üßΩ Liste leeren</button>
        </div>

        <div id="matList" style="margin-top:10px;"></div>
      </details>

      <div class="sep"></div>

      <details open>
        <summary><span>üì∏ Fotos (Baustelle / Aufnahme)</span><span class="pill" id="photoPill">0</span></summary>
        <div class="sep"></div>
        <div class="photoGrid" id="photoGrid"></div>
        <div class="hint" style="margin-top:10px;">Fotos werden im Backup.json mitgesichert (komprimiert).</div>
      </details>

      <div class="sep"></div>
      <div class="btnbar">
        <button class="btn good" id="btnCWhats">üì≤ WhatsApp‚ÄëText (intern)</button>
        <button class="btn" id="btnCDown">‚¨áÔ∏è Download Intern.txt</button>
      </div>
    </details>
  </div>

  <div class="panel tab" data-tab="backup" style="display:none;">
    <details open>
      <summary><span>üíæ Backup / Export (firmensicher)</span><span class="pill">JSON ‚Ä¢ CSV ‚Ä¢ TXT</span></summary>
      <div class="sep"></div>
      <div class="hint">
        Empfehlung:
        <br>‚Ä¢ <b>Backup.json</b> (alles inkl. Fotos) ‚Üí archivieren / importierbar
        <br>‚Ä¢ <b>Material.csv</b> (intern) ‚Üí Excel/Software
        <br>‚Ä¢ <b>Kunde.txt</b> / <b>Intern.txt</b> ‚Üí WhatsApp/Doku
      </div>
      <div class="sep"></div>
      <div class="btnbar">
        <button class="btn primary" id="btnBackup">‚¨áÔ∏è Download Backup.json (alles)</button>
        <button class="btn" id="btnCSV">‚¨áÔ∏è Download Material.csv (intern)</button>
        <button class="btn bad" id="btnReset">‚ö†Ô∏è Alle Daten l√∂schen (lokal)</button>
      </div>
    </details>
  </div>
</div>

<div id="toast" class="toast" style="display:none;"></div>

<script>
(() => {
  "use strict";

  const STORAGE_KEY = "zaunteam_zaunplaner_state";
  const LEGACY_KEYS = ["js_zaunmaterial_deluxe_v1_1","js_zaunmaterial_deluxe_v1_2","js_zaunmaterial_deluxe_v1_3","js_zaunmaterial_deluxe_v1_0"];

  const DEFAULT_HEIGHTS = [60,80,100,120,140,160,180,200];
  const PANEL_W = 2.50;

  const ZAUNTEAM_FARBEN = ["Anthrazit (RAL 7016)","Schwarz (RAL 9005)","Grau (RAL 7030/7035)","Gr√ºn","Wei√ü","Verzinkt / Natur","Holz Natur","Holz Lasur"];
  const HOLZARTEN = ["‚Äî","L√§rche","Douglasie","Kiefer","Fichte","Eiche"];
  const WPC_VARIANTEN = ["‚Äî","glatt","geriffelt","co-extrudiert"];

  const el = (id) => document.getElementById(id);
  const toastEl = el("toast");
  function toast(a,b="") {
    toastEl.style.display="block";
    toastEl.textContent = b ? (a + " ‚Äî " + b) : a;
    setTimeout(()=> toastEl.style.display="none", 2200);
  }
  const fmt = (n) => {
    const x = Number(n);
    if(!Number.isFinite(x)) return "0";
    return (Math.round(x*100)/100).toString().replace(".", ",");
  };
  const toNum = (v, d=0) => {
    if(v==null) return d;
    const s = String(v).trim().replace(",", ".");
    const x = Number(s);
    return Number.isFinite(x) ? x : d;
  };
  const uid = () => Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(3);
  const nowISO = () => new Date().toISOString();

  function escapeHtml(s) {
    return String(s||"").replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[c]));
  }

  let state = { version:"1.4", selectedProjectId:null, projects:[] };

  function blankProject(name) {
    return {
      id: uid(),
      title: name || "Neues Projekt",
      createdAt: nowISO(),
      plannedDate: "",
      phone: "",
      addr: "",
      objAddr: "",
      customer: {
        length: "", height:160, system:"Doppelstab", color:"Anthrazit (RAL 7016)",
        woodType:"", wpcType:"", slopeType:"flat", slopePct:"", corners:0,
        concreteMode:"sacks", concreteValue:"", note:""
      },
      chef: { bagger:"no", ramme:"no", haenger:"no", note:"", materials:[], photos:[] },
      status:"Entwurf"
    };
  }

  function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    updateStatusPill();
  }

  function migrateLegacy() {
    const stable = localStorage.getItem(STORAGE_KEY);
    if(stable) {
      try {
        const s = JSON.parse(stable);
        if(s && Array.isArray(s.projects)) { state = {...state, ...s, version:"1.4"}; return; }
      } catch(e){}
    }
    for(const k of LEGACY_KEYS) {
      const raw = localStorage.getItem(k);
      if(!raw) continue;
      try {
        const s = JSON.parse(raw);
        if(Array.isArray(s.projects) && s.projects.length) {
          const converted = s.projects.map(p => {
            const np = blankProject(p.title || p.name || "Projekt");
            np.id = p.id || np.id;
            np.createdAt = p.createdAt || np.createdAt;
            np.plannedDate = p.plannedDate || "";
            np.phone = p.phone || "";
            np.addr = p.addr || "";
            np.objAddr = p.objAddr || "";
            if(p.plan) {
              np.customer.length = p.plan.length || "";
              np.customer.height = Number(p.plan.height) || 160;
              np.customer.system = p.plan.system || "Doppelstab";
              np.customer.color = p.plan.color || "Anthrazit (RAL 7016)";
              np.customer.woodType = p.plan.woodType || "";
              np.customer.slopeType = p.plan.slopeType || "flat";
              np.customer.slopePct = p.plan.slopePct || "";
              np.customer.corners = Number(p.plan.corners)||0;
              np.customer.concreteMode = p.plan.concreteMode || "sacks";
              np.customer.concreteValue = p.plan.concreteValue || "";
            }
            if(Array.isArray(p.items)) {
              const banned = ["zinkspray","schnur","bodenh√ºlsen","bodenhuelsen","markierungsspray","zink spray"];
              np.chef.materials = p.items.filter(it => {
                const n = String(it.name||"").toLowerCase();
                return !banned.some(b=>n.includes(b));
              }).map(it => ({
                id: it.id || uid(),
                name: it.name || "",
                qty: toNum(it.qty, 0),
                unit: it.unit || "Stk",
                note: it.note || ""
              }));
            }
            return np;
          });
          state.projects = converted;
          state.selectedProjectId = (s.selectedProjectId && converted.some(p=>p.id===s.selectedProjectId)) ? s.selectedProjectId : (converted[0]?.id || null);
          save();
          toast("Daten √ºbernommen", "aus √§lterer Version");
          return;
        }
      } catch(e){}
    }
    const demo = blankProject("Demo ‚Äì Kunde Beispiel");
    demo.plannedDate = "2025-12-16";
    state.projects = [demo];
    state.selectedProjectId = demo.id;
    save();
  }

  function currentProject() {
    return state.projects.find(p=>p.id===state.selectedProjectId) || null;
  }

  function updateStatusPill() {
    const p = currentProject();
    el("statusPill").textContent = p ? (`aktiv: ${p.title} ‚Ä¢ ${p.status}`) : "kein Projekt";
  }

  // Tabs
  function setTab(name) {
    document.querySelectorAll(".tabBtn").forEach(b=>b.classList.toggle("active", b.dataset.tab===name));
    document.querySelectorAll(".panel.tab").forEach(p=>p.style.display = (p.dataset.tab===name) ? "" : "none");
  }
  document.querySelectorAll(".tabBtn").forEach(b=>b.addEventListener("click", ()=> setTab(b.dataset.tab)));

  // Fill
  function fillHeights() {
    const s = el("kHeight");
    s.innerHTML="";
    DEFAULT_HEIGHTS.forEach(h => {
      const o=document.createElement("option");
      o.value=String(h);
      o.textContent=`${h} cm`;
      s.appendChild(o);
    });
  }
  function fillSelect(sel, arr, defVal) {
    sel.innerHTML="";
    arr.forEach(v => {
      const o=document.createElement("option");
      o.value=v; o.textContent=v;
      sel.appendChild(o);
    });
    if(defVal!=null) sel.value=defVal;
  }

  // Projects UI
  const pName=el("pName"), pDate=el("pDate"), pPhone=el("pPhone"), pAddr=el("pAddr"), pObj=el("pObj");
  const projSel=el("projSel"), sortSel=el("sortSel"), projCards=el("projCards"), projCountPill=el("projCountPill");

  function refreshProjectSelectors() {
    const list=[...state.projects];
    if(sortSel.value==="name") list.sort((a,b)=>(a.title||"").localeCompare(b.title||"","de"));
    if(sortSel.value==="date") list.sort((a,b)=>(a.plannedDate||"9999-12-31").localeCompare(b.plannedDate||"9999-12-31"));
    if(sortSel.value==="created") list.sort((a,b)=>(a.createdAt||"").localeCompare(b.createdAt||""));
    projSel.innerHTML="";
    list.forEach(p=>{
      const o=document.createElement("option");
      o.value=p.id;
      o.textContent=`${p.title}${p.plannedDate?(" ‚Ä¢ "+p.plannedDate):""}`;
      projSel.appendChild(o);
    });
    projSel.value = state.selectedProjectId || "";
    projCards.innerHTML="";
    list.forEach(p=>{
      const div=document.createElement("div");
      div.className="card";
      div.innerHTML = `
        <div class="cardTitle">
          <b>${escapeHtml(p.title)}</b>
          <span class="pill ${p.status==="Freigegeben"?"good":""}">${escapeHtml(p.status||"Entwurf")}</span>
        </div>
        <div class="meta">Erstellt: ${(p.createdAt||"").slice(0,10)||"‚Äî"} ‚Ä¢ Ausf√ºhrung: ${p.plannedDate||"‚Äî"}</div>
        <div class="meta">Tel: ${escapeHtml(p.phone||"‚Äî")} ‚Ä¢ Kunde: ${escapeHtml(p.addr||"‚Äî")}</div>
      `;
      div.addEventListener("click", ()=>{
        state.selectedProjectId = p.id;
        save(); refreshAll();
        setTab("kunde");
        setTimeout(()=>el("kLen").focus(), 120);
      });
      projCards.appendChild(div);
    });
    projCountPill.textContent = String(state.projects.length);
  }

  el("btnAdd").addEventListener("click", ()=>{
    const name=(pName.value||"").trim() || "Neues Projekt";
    const p = blankProject(name);
    p.plannedDate = pDate.value || "";
    p.phone = (pPhone.value||"").trim();
    p.addr = (pAddr.value||"").trim();
    p.objAddr = (pObj.value||"").trim();
    state.projects.unshift(p);
    state.selectedProjectId = p.id;
    pName.value=""; pDate.value=""; pPhone.value=""; pAddr.value=""; pObj.value="";
    save(); refreshAll();
    toast("Projekt erstellt", p.title);
    setTab("kunde");
  });

  el("btnDup").addEventListener("click", ()=>{
    const p=currentProject(); if(!p) return;
    const copy = JSON.parse(JSON.stringify(p));
    copy.id = uid();
    copy.title = p.title + " (Kopie)";
    copy.createdAt = nowISO();
    state.projects.unshift(copy);
    state.selectedProjectId = copy.id;
    save(); refreshAll();
    toast("Dupliziert", copy.title);
  });

  el("btnDel").addEventListener("click", ()=>{
    const p=currentProject(); if(!p) return;
    if(!confirm(`Projekt wirklich l√∂schen?\n\n${p.title}`)) return;
    state.projects = state.projects.filter(x=>x.id!==p.id);
    state.selectedProjectId = state.projects[0]?.id || null;
    save(); refreshAll();
    toast("Gel√∂scht");
  });

  sortSel.addEventListener("change", refreshProjectSelectors);
  projSel.addEventListener("change", ()=>{
    state.selectedProjectId = projSel.value || null;
    save(); refreshAll();
  });

  // Kunde
  const kLen=el("kLen"), kHeight=el("kHeight"), kSystem=el("kSystem"), kColor=el("kColor"), kWood=el("kWood"), kWpc=el("kWpc");
  const kSlopeType=el("kSlopeType"), kSlopePct=el("kSlopePct"), kCorners=el("kCorners"), kConcreteMode=el("kConcreteMode"), kConcreteVal=el("kConcreteVal"), kNote=el("kNote");
  const kundeKpi=el("kundeKpi");

  function clampInt(v, lo=0, hi=99) {
    const n=Math.trunc(Number(v));
    if(!Number.isFinite(n)) return lo;
    return Math.max(lo, Math.min(hi, n));
  }
  function setCorners(v){ kCorners.value = String(clampInt(v)); }
  el("kCornersMinus").addEventListener("click", ()=>{ setCorners(clampInt(kCorners.value)-1); persistCustomer(); });
  el("kCornersPlus").addEventListener("click", ()=>{ setCorners(clampInt(kCorners.value)+1); persistCustomer(); });
  kCorners.addEventListener("change", ()=>{ setCorners(kCorners.value); persistCustomer(); });

  function updateConcretePlaceholder(){ kConcreteVal.placeholder = (kConcreteMode.value==="m3") ? "z.B. 0,8" : "z.B. 18"; }
  kConcreteMode.addEventListener("change", ()=>{ updateConcretePlaceholder(); persistCustomer(); });

  function toggleMaterialDependent(){
    const sys = kSystem.value;
    kWood.disabled = (sys!=="Holz");
    kWpc.disabled = (sys!=="WPC");
  }
  kSystem.addEventListener("change", ()=>{ toggleMaterialDependent(); persistCustomer(); });

  function persistCustomer() {
    const p=currentProject(); if(!p) return;
    const c=p.customer;
    c.length=(kLen.value||"").trim();
    c.height=Number(kHeight.value)||160;
    c.system=kSystem.value;
    c.color=kColor.value;
    c.woodType=(kWood.value==="‚Äî")?"":kWood.value;
    c.wpcType=(kWpc.value==="‚Äî")?"":kWpc.value;
    c.slopeType=kSlopeType.value;
    c.slopePct=(kSlopePct.value||"").trim();
    c.corners=clampInt(kCorners.value);
    c.concreteMode=kConcreteMode.value;
    c.concreteValue=(kConcreteVal.value||"").trim();
    c.note=(kNote.value||"").trim();
    save();
    refreshKpi();
  }

  [kLen,kHeight,kSystem,kColor,kWood,kWpc,kSlopeType,kSlopePct,kConcreteVal,kNote].forEach(x=>{
    x.addEventListener("input", persistCustomer);
    x.addEventListener("change", persistCustomer);
  });

  function computeTotals(c){
    const lengthM=Math.max(0, toNum(c.length,0));
    const panels=lengthM ? Math.ceil(lengthM/PANEL_W) : 0;
    const posts=panels ? (panels+1) : 0;
    const corners=clampInt(c.corners||0);
    const cornerPosts=corners;
    const postStrips=posts ? (posts+corners) : 0;
    return {lengthM, panels, posts, cornerPosts, postStrips};
  }
  function sysLabel(c){
    const h=Number(c.height)||160;
    const base = (c.system==="Doppelstab")?"Doppelstab‚ÄëMatten":(c.system==="Aluminium")?"Alu‚ÄëElemente":(c.system==="Holz")?"Holz‚ÄëElemente":(c.system==="WPC")?"WPC‚ÄëElemente":"Zaun‚ÄëElemente";
    return `${base} 2,50m ‚Ä¢ ${h} cm`;
  }

  function refreshKpi(){
    const p=currentProject(); if(!p) return;
    const c=p.customer;
    const t=computeTotals(c);
    const ok=!!(c.length||"").trim();
    const pill=el("kundePill");
    pill.textContent = ok ? "gesetzt" : "leer";
    pill.className = "pill " + (ok ? "good" : "");
    el("kundeTitle").textContent = `üë§ Kunde: ${p.title}`;
    kundeKpi.innerHTML="";
    if(!ok) return;
    const add = (txt)=>{ const sp=document.createElement("span"); sp.className="pill"; sp.innerHTML=txt; kundeKpi.appendChild(sp); };
    add(`Matten/Elemente: <b>${t.panels}</b>`);
    add(`Pfosten: <b>${t.posts}</b>`);
    if(t.cornerPosts) add(`Eckpfosten: <b>${t.cornerPosts}</b>`);
    add(`Pfostenleisten: <b>${t.postStrips}</b>`);
  }

  function upsertMat(list, name, qty, unit, note){
    const key=String(name||"").toLowerCase();
    const it=list.find(x=>String(x.name||"").toLowerCase()===key);
    if(it){ it.qty=Number(qty)||0; it.unit=unit||"Stk"; if(note) it.note=note; }
    else list.unshift({id:uid(), name, qty:Number(qty)||0, unit:unit||"Stk", note:note||""});
  }

  el("btnKCalc").addEventListener("click", ()=>{
    const p=currentProject(); if(!p) return;
    const c=p.customer;
    const t=computeTotals(c);
    if(!t.lengthM) return toast("L√§nge fehlt","Bitte Zaunl√§nge eingeben");
    const mats=p.chef.materials;
    upsertMat(mats, "Zaun‚Äë√úbersicht", 1, "Stk", `${fmt(t.lengthM)} m ‚Ä¢ ${c.height} cm ‚Ä¢ ${c.system} ‚Ä¢ ${c.color}${(c.system==="Holz"&&c.woodType)?(" ‚Ä¢ "+c.woodType):""}${(c.system==="WPC"&&c.wpcType)?(" ‚Ä¢ "+c.wpcType):""}`);
    upsertMat(mats, sysLabel(c), t.panels, "Stk", "gesamt");
    upsertMat(mats, "Pfosten", t.posts, "Stk", "gesamt");
    if(t.cornerPosts) upsertMat(mats, "Eckpfosten", t.cornerPosts, "Stk", "gesamt");
    upsertMat(mats, "Pfostenleisten", t.postStrips, "Stk", "gesamt");
    const cv=(c.concreteValue||"").trim();
    if(cv){
      const unit=(c.concreteMode==="m3")?"m¬≥":"Sack";
      upsertMat(mats, "Beton", toNum(cv,0), unit, "Kunde");
    }
    save();
    refreshChefUI();
    toast("√úbernommen","‚Üí Chef‚ÄëMaterialliste");
    setTab("chef");
  });

  function customerWhatsText(p){
    const c=p.customer;
    const t=computeTotals(c);
    const lines=[];
    lines.push(`ZAUN ‚Äì ${p.title}`);
    if(p.plannedDate) lines.push(`Ausf√ºhrung: ${p.plannedDate}`);
    if(p.phone) lines.push(`Tel: ${p.phone}`);
    if(p.addr) lines.push(`Adresse: ${p.addr}`);
    if(p.objAddr) lines.push(`Objekt: ${p.objAddr}`);
    lines.push("");
    if(t.lengthM) lines.push(`‚Ä¢ L√§nge: ${fmt(t.lengthM)} m`);
    if(c.height) lines.push(`‚Ä¢ H√∂he: ${c.height} cm`);
    if(c.system){
      let sys=c.system;
      if(c.system==="Holz" && c.woodType) sys += ` (${c.woodType})`;
      if(c.system==="WPC" && c.wpcType) sys += ` (${c.wpcType})`;
      lines.push(`‚Ä¢ System: ${sys}`);
    }
    if(c.color) lines.push(`‚Ä¢ Farbe: ${c.color}`);
    const slopeTxt=({flat:"gerade",slope:"absch√ºssig",hang:"am Hang",steep:"steil"})[c.slopeType] || "gerade";
    if(c.slopeType && c.slopeType!=="flat") lines.push(`‚Ä¢ Gel√§nde: ${slopeTxt}${(c.slopePct||"").trim()?(" ("+c.slopePct.trim()+"%)"):""}`);
    if(clampInt(c.corners||0)>0) lines.push(`‚Ä¢ Ecken: ${clampInt(c.corners||0)}`);
    const cv=(c.concreteValue||"").trim();
    if(cv) lines.push(`‚Ä¢ Beton: ${cv} ${(c.concreteMode==="m3")?"m¬≥":"Sack"}`);
    lines.push("");
    if(t.lengthM){
      lines.push("Material (√úbersicht):");
      lines.push(`- Matten/Elemente: ${t.panels} Stk`);
      lines.push(`- Pfosten: ${t.posts} Stk`);
      if(t.cornerPosts) lines.push(`- Eckpfosten: ${t.cornerPosts} Stk`);
      lines.push(`- Pfostenleisten: ${t.postStrips} Stk`);
      if(cv) lines.push(`- Beton: ${cv} ${(c.concreteMode==="m3")?"m¬≥":"Sack"}`);
    }
    if(c.note){
      lines.push("");
      lines.push("Notiz:");
      lines.push(c.note);
    }
    return lines.join("\n");
  }

  async function shareText(text, title){
    try{
      if(navigator.share){ await navigator.share({title:title||"Zaunplaner", text}); return; }
    }catch(e){}
    try{ await navigator.clipboard.writeText(text); toast("Kopiert","in Zwischenablage"); }
    catch(e){ prompt("Kopieren:", text); }
  }

  function downloadText(text, filename, mime="text/plain"){
    const blob=new Blob([text], {type:mime+";charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download=filename;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 800);
  }
  function fileSafe(name){ return String(name||"Datei.txt").replace(/[\\/:*?"<>|]+/g,"_").trim(); }

  el("btnKWhats").addEventListener("click", async ()=>{ const p=currentProject(); if(!p) return; await shareText(customerWhatsText(p),"Kunden√ºbersicht"); });
  el("btnKDown").addEventListener("click", ()=>{ const p=currentProject(); if(!p) return; downloadText(customerWhatsText(p), fileSafe(`${p.title}_Kunde.txt`)); });

  // Chef
  const cBagger=el("cBagger"), cRamme=el("cRamme"), cHaenger=el("cHaenger"), cNote=el("cNote");
  const matPill=el("matPill"), matList=el("matList"), mName=el("mName"), mQty=el("mQty"), mUnit=el("mUnit"), mNote=el("mNote");
  const photoGrid=el("photoGrid"), photoPill=el("photoPill");

  function persistChef(){
    const p=currentProject(); if(!p) return;
    p.chef.bagger=cBagger.value; p.chef.ramme=cRamme.value; p.chef.haenger=cHaenger.value;
    p.chef.note=(cNote.value||"").trim();
    save(); refreshChefPill();
  }
  [cBagger,cRamme,cHaenger,cNote].forEach(x=>{ x.addEventListener("change", persistChef); x.addEventListener("input", persistChef); });

  function refreshChefPill(){
    const p=currentProject(); if(!p) return;
    const ok = (p.chef.materials||[]).length || (p.chef.note||"").trim() || (p.chef.photos||[]).length;
    el("chefPill").textContent = ok ? "gesetzt" : "leer";
    el("chefPill").className = "pill " + (ok ? "good" : "");
  }

  function refreshChefUI(){
    const p=currentProject();
    el("chefTitle").textContent = p ? `üõ†Ô∏è Chef/Team: ${p.title}` : "üõ†Ô∏è Chef / Team";
    if(!p) return;
    cBagger.value=p.chef.bagger||"no";
    cRamme.value=p.chef.ramme||"no";
    cHaenger.value=p.chef.haenger||"no";
    cNote.value=p.chef.note||"";
    renderMaterials(); renderPhotos(); refreshChefPill();
  }

  el("btnAddMat").addEventListener("click", ()=>{
    const p=currentProject(); if(!p) return;
    const name=(mName.value||"").trim(); if(!name) return toast("Name fehlt");
    const qty=toNum(mQty.value,0); const unit=mUnit.value||"Stk"; const note=(mNote.value||"").trim();
    p.chef.materials.unshift({id:uid(), name, qty, unit, note});
    mName.value=""; mQty.value=""; mNote.value="";
    save(); renderMaterials(); refreshChefPill(); toast("Hinzugef√ºgt", name);
  });

  el("btnClearMat").addEventListener("click", ()=>{
    const p=currentProject(); if(!p) return;
    if(!confirm("Interne Materialliste wirklich leeren?")) return;
    p.chef.materials=[]; save(); renderMaterials(); refreshChefPill();
  });

  function renderMaterials(){
    const p=currentProject(); if(!p) return;
    const list=p.chef.materials||[];
    matPill.textContent=String(list.length);
    if(!list.length){ matList.innerHTML='<div class="hint">(noch leer)</div>'; return; }
    matList.innerHTML="";
    list.forEach(it=>{
      const row=document.createElement("div");
      row.className="card"; row.style.cursor="default";
      row.innerHTML = `
        <div class="cardTitle">
          <b>${escapeHtml(it.name)}</b>
          <button class="btn small bad" type="button">‚úï</button>
        </div>
        <div class="grid2" style="margin-top:10px;">
          <div><label>Menge</label><input value="${escapeHtml(it.qty)}" inputmode="decimal"/></div>
          <div>
            <label>Einheit</label>
            <select>${["Stk","m","m¬≤","Sack","m¬≥","Paket"].map(u=>`<option ${u===it.unit?"selected":""}>${u}</option>`).join("")}</select>
          </div>
        </div>
        <div style="margin-top:10px;"><label>Notiz</label><textarea>${escapeHtml(it.note||"")}</textarea></div>
      `;
      const btnDel=row.querySelector("button");
      const inpQty=row.querySelectorAll("input")[0];
      const selUnit=row.querySelectorAll("select")[0];
      const ta=row.querySelector("textarea");
      btnDel.addEventListener("click", ()=>{
        const p2=currentProject(); if(!p2) return;
        p2.chef.materials=(p2.chef.materials||[]).filter(x=>x.id!==it.id);
        save(); renderMaterials(); refreshChefPill();
      });
      const commit=()=>{
        const p2=currentProject(); if(!p2) return;
        const tgt=(p2.chef.materials||[]).find(x=>x.id===it.id); if(!tgt) return;
        tgt.qty=toNum(inpQty.value,0); tgt.unit=selUnit.value; tgt.note=(ta.value||"").trim(); save();
      };
      [inpQty,selUnit,ta].forEach(x=>{ x.addEventListener("change",commit); x.addEventListener("input",()=>setTimeout(commit,250)); });
      matList.appendChild(row);
    });
  }

  function compressImageToDataUrl(file, maxSide=1280, quality=0.72){
    return new Promise((resolve,reject)=>{
      const fr=new FileReader();
      fr.onload=()=>{
        const img=new Image();
        img.onload=()=>{
          const w=img.width, h=img.height;
          const scale=Math.min(1, maxSide/Math.max(w,h));
          const nw=Math.round(w*scale), nh=Math.round(h*scale);
          const cv=document.createElement("canvas");
          cv.width=nw; cv.height=nh;
          const ctx=cv.getContext("2d");
          ctx.drawImage(img,0,0,nw,nh);
          resolve(cv.toDataURL("image/jpeg", quality));
        };
        img.onerror=reject;
        img.src=fr.result;
      };
      fr.onerror=reject;
      fr.readAsDataURL(file);
    });
  }

  function renderPhotos(){
    const p=currentProject(); if(!p) return;
    const ph=p.chef.photos||[];
    photoPill.textContent=String(ph.length);
    photoGrid.innerHTML="";
    const max=6;
    for(let i=0;i<max;i++){
      const slot=ph[i];
      const div=document.createElement("div");
      div.className="ph";
      if(slot){
        div.innerHTML = `
          <div class="cardTitle"><b>Foto ${i+1}</b><button class="btn small bad" type="button">‚úï</button></div>
          <div class="meta">${escapeHtml(slot.name||"")}</div>
          <div style="margin-top:8px;"><img src="${slot.dataUrlSmall}" alt="Foto"/></div>
        `;
        div.querySelector("button").addEventListener("click", ()=>{
          const p2=currentProject(); if(!p2) return;
          p2.chef.photos.splice(i,1);
          save(); renderPhotos(); refreshChefPill();
        });
      } else {
        div.innerHTML = `
          <b>+ Foto hinzuf√ºgen</b>
          <div class="meta">Tippen ‚Üí Kamera / Mediathek</div>
          <div style="margin-top:8px;"><input type="file" accept="image/*" capture="environment"/></div>
        `;
        const input=div.querySelector("input");
        input.addEventListener("change", async ()=>{
          const file=input.files && input.files[0];
          if(!file) return;
          const dataUrlSmall = await compressImageToDataUrl(file, 1280, 0.72);
          const p2=currentProject(); if(!p2) return;
          p2.chef.photos=p2.chef.photos||[];
          p2.chef.photos.push({id:uid(), name:file.name||"foto.jpg", type:file.type||"image/jpeg", dataUrlSmall});
          save(); renderPhotos(); refreshChefPill(); toast("Foto gespeichert");
        });
      }
      photoGrid.appendChild(div);
    }
  }

  function chefWhatsText(p){
    const lines=[];
    lines.push(`INTERN ‚Äì ${p.title}`);
    if(p.plannedDate) lines.push(`Ausf√ºhrung: ${p.plannedDate}`);
    if(p.phone) lines.push(`Tel: ${p.phone}`);
    if(p.addr) lines.push(`Kunde: ${p.addr}`);
    if(p.objAddr) lines.push(`Objekt: ${p.objAddr}`);
    lines.push("");
    const eq=[];
    if(p.chef.bagger==="yes") eq.push("Bagger");
    if(p.chef.ramme==="yes") eq.push("Ramme");
    if(p.chef.haenger==="yes") eq.push("H√§nger");
    if(eq.length){
      lines.push("Ger√§te:");
      eq.forEach(x=>lines.push(`- ${x}`));
      lines.push("");
    }
    const mats=p.chef.materials||[];
    lines.push("Material (intern):");
    if(!mats.length) lines.push("(leer)");
    else mats.forEach(it=>{
      const q=fmt(toNum(it.qty,0));
      const u=it.unit||"Stk";
      const note=(it.note||"").trim();
      lines.push(`- ${it.name}: ${q} ${u}${note?(" ("+note+")"):""}`);
    });
    const ph=p.chef.photos||[];
    if(ph.length){ lines.push(""); lines.push(`Fotos: ${ph.length} (im Backup.json)`); }
    if((p.chef.note||"").trim()){
      lines.push("");
      lines.push("Hinweise:");
      lines.push(p.chef.note.trim());
    }
    return lines.join("\n");
  }

  el("btnCWhats").addEventListener("click", async ()=>{ const p=currentProject(); if(!p) return; await shareText(chefWhatsText(p),"Intern"); });
  el("btnCDown").addEventListener("click", ()=>{ const p=currentProject(); if(!p) return; downloadText(chefWhatsText(p), fileSafe(`${p.title}_Intern.txt`)); });

  // Backup
  el("btnBackup").addEventListener("click", ()=>{
    const data={ exportedAt: nowISO(), tool:"Zaunteam Zaunplaner", version:"1.4", state };
    downloadText(JSON.stringify(data,null,2), "Zaunplaner_Backup.json", "application/json");
  });
  el("btnCSV").addEventListener("click", ()=>{
    const p=currentProject(); if(!p) return toast("Kein Projekt");
    const rows=[["Projekt","Datum","Material","Menge","Einheit","Notiz"]].concat((p.chef.materials||[]).map(it=>[p.title,p.plannedDate||"",it.name||"",String(it.qty??""),it.unit||"",it.note||""]));
    const csv=rows.map(r=>r.map(cell=>`"${String(cell).replace(/"/g,'""')}"`).join(";")).join("\n");
    downloadText(csv, fileSafe(`${p.title}_Material.csv`), "text/csv");
  });
  el("btnReset").addEventListener("click", ()=>{
    if(!confirm("Wirklich ALLE lokalen Daten l√∂schen?")) return;
    localStorage.removeItem(STORAGE_KEY);
    LEGACY_KEYS.forEach(k=>localStorage.removeItem(k));
    location.reload();
  });

  function refreshCustomerUI(){
    const p=currentProject(); if(!p) return;
    const c=p.customer;
    el("kundeTitle").textContent = `üë§ Kunde: ${p.title}`;
    kLen.value=c.length||"";
    kHeight.value=String(c.height||160);
    kSystem.value=c.system||"Doppelstab";
    kColor.value=c.color||"Anthrazit (RAL 7016)";
    kWood.value=c.woodType||"‚Äî";
    kWpc.value=c.wpcType||"‚Äî";
    kSlopeType.value=c.slopeType||"flat";
    kSlopePct.value=c.slopePct||"";
    setCorners(c.corners||0);
    kConcreteMode.value=c.concreteMode||"sacks";
    updateConcretePlaceholder();
    kConcreteVal.value=c.concreteValue||"";
    kNote.value=c.note||"";
    toggleMaterialDependent();
    refreshKpi();
  }

  function refreshChefUI(){
    const p=currentProject();
    el("chefTitle").textContent = p ? `üõ†Ô∏è Chef/Team: ${p.title}` : "üõ†Ô∏è Chef / Team";
    if(!p) return;
    cBagger.value=p.chef.bagger||"no";
    cRamme.value=p.chef.ramme||"no";
    cHaenger.value=p.chef.haenger||"no";
    cNote.value=p.chef.note||"";
    renderMaterials(); renderPhotos(); refreshChefPill();
  }

  function refreshAll(){
    refreshProjectSelectors();
    refreshCustomerUI();
    refreshChefUI();
    updateStatusPill();
  }

  // init
  fillHeights();
  fillSelect(kColor, ZAUNTEAM_FARBEN, "Anthrazit (RAL 7016)");
  fillSelect(kWood, HOLZARTEN, "‚Äî");
  fillSelect(kWpc, WPC_VARIANTEN, "‚Äî");
  updateConcretePlaceholder();
  migrateLegacy();
  refreshAll();
})();
</script>
</body>
</html>
