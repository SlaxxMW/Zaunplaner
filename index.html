<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Zaunteam Zaunplaner</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#e6e6e6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <style>
    :root{
      /* Zaunteam Mid-Dark (kr√§ftig, aber nicht zu dunkel) */
      --bg1:#111827;          /* slate-900 */
      --bg2:#334155;          /* slate-700 */
      --panel:#253247;        /* panel */
      --card:#1f2a3d;         /* card */
      --card2:#22314a;

      --field:#2a3b55;        /* input background */
      --field2:#314766;

      --line:rgba(255,255,255,.16);
      --line2:rgba(122,193,65,.40);

      --txt:#f8fafc;
      --muted:#e2e8f0;

      --green:#7ac141;        /* Zaunteam green */
      --green2:#b7f36b;       /* brighter */
      --red:#e53935;          /* Zaunteam red */
      --red2:#ff6b63;

      --pill:rgba(122,193,65,.22);
      --pill2:rgba(0,166,251,.14);

      --shadow:0 14px 34px rgba(0,0,0,.32);
      --shadow2:0 6px 18px rgba(0,0,0,.24);

      --r:16px;
    }
    *{ box-sizing:border-box; }
    html,body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1200px 800px at 10% 0%, rgba(122,193,65,.18), transparent 55%),
        radial-gradient(1000px 700px at 95% 20%, rgba(229,57,53,.12), transparent 55%),
        radial-gradient(900px 650px at 60% 110%, rgba(0,166,251,.12), transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--txt);
      background:
        radial-gradient(900px 420px at 10% 0%, rgba(200,31,54,.10), transparent 60%),
        radial-gradient(900px 420px at 90% 0%, rgba(0,0,0,.08), transparent 60%),
        var(--bg);
    }
    .wrap{ max-width:1160px; margin:0 auto; padding:14px; }
    .topbar{
      background:linear-gradient(180deg, rgba(31,42,61,.92), rgba(34,49,74,.86));
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    /* Zaunteam Stripe */
    .topbar:before{
      content:"";
      position:absolute;
      left:0; right:0; top:0;
      height:6px;
      background:linear-gradient(90deg, var(--green), var(--green2), var(--red), var(--red2));
      opacity:.95;
    }
    .toprow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{
      font-weight:950;
      letter-spacing:.2px;
      color:var(--green2);
      text-shadow:0 1px 0 rgba(0,0,0,.35);
    }
    .brand small{
      font-weight:800;
      color:rgba(226,232,240,.92);
      font-size:12px;
    }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:linear-gradient(180deg, rgba(122,193,65,.22), rgba(0,166,251,.10));
      border:1px solid rgba(255,255,255,.14);
      font-size:12px;
      color:var(--txt);
      white-space:nowrap;
    }
    .pill.good{ border-color:#bfe6bf; background:#e9f6e9; color:var(--good); }
    .pill.bad{ border-color:#f2b6c0; background:#fde9ee; color:var(--bad); }
    .pill.accent{ border-color:rgba(200,31,54,.35); background:rgba(200,31,54,.10); color:var(--accent2); }

    .tabs{ display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
    .tabBtn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(17,24,39,.55);
      color:var(--txt);
      padding:9px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      box-shadow:var(--shadow2);
    }
    .tabBtn:hover{ transform: translateY(-1px); }
    .tabBtn.active{
      background:linear-gradient(180deg, rgba(122,193,65,.35), rgba(122,193,65,.18));
      color:var(--txt);
      border-color:rgba(122,193,65,.65);
      box-shadow:0 0 0 3px rgba(122,193,65,.12), var(--shadow2);
    }

    .panel{
      margin-top:12px;
      background:linear-gradient(180deg, rgba(37,50,71,.92), rgba(31,42,61,.92));
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
    }
    h2{ margin:0 0 10px; font-size:18px; }
    label{ display:block; font-size:12px; color:rgba(226,232,240,.92); margin:8px 0 4px; }
    .inputBlock{}
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, var(--field), var(--field2));
      color:var(--txt);
      font-size:14px;
      outline:none;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(200,31,54,.55);
      box-shadow: 0 0 0 4px rgba(200,31,54,.12);
    }
    textarea{ min-height:92px; resize:vertical; }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    @media (max-width:860px){ .grid2,.grid3{ grid-template-columns:1fr; } }

    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:950;
      transition:transform .08s ease, box-shadow .12s ease, filter .12s ease;
      box-shadow:var(--shadow2);
    }
    .btn:hover{ filter:brightness(1.06); }
    .btn:active{ transform:translateY(1px); }
    .btn:hover{ filter:brightness(1.02); }
    .btn:active{ transform:translateY(1px); box-shadow:0 2px 8px rgba(2,6,23,.12); }

    .btn:hover{ transform: translateY(-1px); }
    .btn.bad{ border-color:#f2b6c0; color:var(--bad); }
    .btn.good{ border-color:#bfe6bf; color:var(--good); }
    .btn.accent{ border-color:rgba(200,31,54,.45); background:rgba(200,31,54,.10); }
    .btn.small{ padding:7px 10px; font-size:12px; border-radius:12px; }
    .btn.green{ background:linear-gradient(180deg, rgba(122,193,65,.42), rgba(122,193,65,.18)); border-color:rgba(122,193,65,.70); color:#052e16; }
    .btn.blue{ background:linear-gradient(180deg, rgba(0,166,251,.38), rgba(0,166,251,.14)); border-color:rgba(0,166,251,.60); color:#001a33; }
    .btn.orange{ background:linear-gradient(180deg, rgba(245,158,11,.45), rgba(245,158,11,.16)); border-color:rgba(245,158,11,.70); color:#2a1200; }
    .btn.purple{ background:linear-gradient(180deg, rgba(99,102,241,.40), rgba(99,102,241,.14)); border-color:rgba(99,102,241,.65); color:#0b1026; }
    .btn.dark{ background:linear-gradient(180deg, rgba(229,57,53,.42), rgba(229,57,53,.18)); border-color:rgba(229,57,53,.70); color:#2a0000; }
    .btn.green:hover,.btn.blue:hover,.btn.orange:hover,.btn.purple:hover,.btn.dark:hover{ filter:brightness(1.08); }
    .btn.green:hover,.btn.blue:hover,.btn.orange:hover,.btn.purple:hover,.btn.dark:hover{ filter:brightness(1.04); }


    .hint{ color:rgba(226,232,240,.92); font-size:13px; }

    .card{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:linear-gradient(180deg, rgba(31,42,61,.92), rgba(34,49,74,.92));
      box-shadow:var(--shadow2);
      margin-top:10px;
    }
    .cardTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .meta{ color:rgba(226,232,240,.92); font-size:12px; margin-top:4px; }

    /* Gate UI */
    .gateRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap:10px;
      align-items:end;
      padding:10px;
      border:1px dashed var(--line);
      border-radius:14px;
      margin-top:10px;
      background: #fafafa;
    }
    .gateAct{ display:flex; gap:8px; }
    @media (max-width:860px){
      .gateRow{ grid-template-columns:1fr; }
      .gateAct{ justify-content:flex-end; }
    }

    /* Fotos */
    #photoGrid{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width:860px){ #photoGrid{ grid-template-columns:repeat(2, 1fr);} }
    .ph{
      border:1px dashed var(--line);
      border-radius:16px;
      padding:10px;
      background:#fafafa;
      min-height:140px;
    }
    .ph img{ width:100%; border-radius:14px; display:block; }

    #toast{
      display:none;
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      z-index:9999;
      max-width:min(720px, calc(100% - 22px));
      background:linear-gradient(90deg, rgba(122,193,65,.28), rgba(229,57,53,.22), rgba(0,166,251,.22), rgba(17,24,39,.95));
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 14px 38px rgba(0,0,0,.45);
      font-weight:900;
      font-size:13px;
    }
  
    /* Dropdown readability (native dropdown lists) */
    select{ color:var(--txt); }
    select option{ background:#f8fafc; color:#0f172a; }
    /* Safari/iOS sometimes uses optgroup */
    optgroup{ background:#f8fafc; color:#0f172a; }

    /* Materialliste kompakt (Chef) */
    #matList details{ border:1px solid var(--line); border-radius:16px; overflow:hidden; background:rgba(255,255,255,.04); }
    #matList summary{ cursor:pointer; padding:10px 12px; font-weight:900; list-style:none; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    #matList summary::-webkit-details-marker{ display:none; }
    .matRows{ padding:10px 12px 12px; display:flex; flex-direction:column; gap:8px; }
    .matRow{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      display:grid;
      grid-template-columns: 1fr 110px 90px 44px;
      gap:8px;
      align-items:center;
    }
    .matRow .matName{ font-weight:900; }
    .matRow input{ padding:8px 10px; border-radius:12px; }
    .matRow select{ padding:8px 10px; border-radius:12px; }
    .matRow .btn{ padding:8px 10px; border-radius:12px; }
    @media (max-width:820px){
      .matRow{ grid-template-columns: 1fr 110px 90px 44px; }
    }
</style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="toprow">
        <div class="row">
          <div class="brand">Zaunteam Zaunplaner <small id="verPill" class="pill accent">v‚Äî</small></div>
          <span class="pill" id="statusPill">kein Projekt</span>
          <span class="pill" id="projCountPill">0</span>
        </div>
        <div class="row">
          <button class="btn small" id="btnBackup" type="button">Backup.json</button>
          <button class="btn small" id="btnCSV" type="button">Material CSV</button>
          <button class="btn small bad" id="btnReset" type="button">Reset</button>
        </div>
      </div>

      <div class="tabs">
        <button class="tabBtn active" data-tab="kunde" type="button">üë§ Kunde / Projekt</button>
        <button class="tabBtn" data-tab="chef" type="button">üõ†Ô∏è Chef/Team</button>
      </div>
    </div>

    <!-- KUNDE/PROJEKT (vereint) -->
    <section class="panel tab" data-tab="kunde">
      <div class="cardTitle">
        <h2>üë§ Kunden</h2>
        <span class="pill" id="projCountPill">0</span>
      </div>

      <!-- LIST VIEW -->
      <div id="kundenListView">
        <div class="card">
          <div class="row">
            <div style="flex:1;">
              <label>Kunde ausw√§hlen</label>
              <select id="projSel"></select>
            </div>
            <div style="display:flex; gap:8px; align-items:flex-end;">
              <button id="btnOpenCustomer" class="btn green" type="button">√ñffnen</button>
              <button id="btnAdd" class="btn dark" type="button">+ Neuer Kunde</button>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div style="flex:1;">
              <label>Kundenname (f√ºr Neu)</label>
              <input id="pName" placeholder="Neuer Kunde" />
            </div>
          </div>

          <details style="margin-top:10px;">
            <summary style="cursor:pointer; font-weight:900;">Optionale Basisdaten (bei Neu)</summary>
            <div class="row" style="margin-top:10px;">
              <div style="flex:1;">
                <label>Erstellt (optional)</label>
                <input id="pCreated" type="date" />
              </div>
              <div style="flex:1;">
                <label>Ausf√ºhrung (optional)</label>
                <input id="pDate" type="date" />
              </div>
            </div>
            <div class="row" style="margin-top:10px;">
              <div style="flex:1;">
                <label>Telefon (optional)</label>
                <input id="pPhone" placeholder="+49..." />
              </div>
              <div style="flex:1;">
                <label>E‚ÄëMail (optional)</label>
                <input id="pEmail" placeholder="mail@..." />
              </div>
            </div>
            <div class="row" style="margin-top:10px;">
              <div style="flex:1;">
                <label>Adresse Kunde (optional)</label>
                <input id="pAddr" placeholder="Stra√üe, PLZ Ort" />
              </div>
              <div style="flex:1;">
                <label>Objektadresse (optional)</label>
                <input id="pObj" placeholder="falls abweichend" />
              </div>
            </div>
          </details>

          <div class="hint" style="margin-top:10px;">
            Tipp: W√§hle einen Kunden im Dropdown ‚Üí ‚Äû√ñffnen‚Äú. Im Bearbeiten‚ÄëModus wird automatisch gespeichert.
          </div>
        </div>

        <div id="projCards" style="display:none;"></div>
      </div>

      <!-- EDIT VIEW -->
      <div id="kundenEditView" style="display:none;">
        <div class="row" style="margin-bottom:10px;">
          <button id="btnBackToList" class="btn blue" type="button">‚Üê Zur√ºck zur Kundenliste</button>
        </div>


      <div class="cardTitle">
        <h2 id="kundeTitle">üë§ Kunde</h2>
        <span class="pill" id="kundePill">leer</span>
      </div>
      <div id="kundeKpi" class="row" style="margin-top:8px;"></div>

      <div class="grid3">
        <div>
          <label>Erstellt</label>
          <input id="kCreated" type="date" />
        </div>
        <div>
          <label>Ausf√ºhrung</label>
          <input id="kPlanned" type="date" />
        </div>
        <div>
          <label>Telefon</label>
          <input id="kPhone" inputmode="tel" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>E‚ÄëMail</label>
          <input id="kEmail" inputmode="email" />
        </div>
        <div>
          <label>Zaunl√§nge (m)</label>
          <input id="kLen" inputmode="decimal" placeholder="z. B. 17,5" />
        </div>
      </div>

      <div class="grid3">
        <div>
          <label>H√∂he</label>
          <select id="kHeight"></select>
        </div>
        <div>
          <label>System</label>
          <select id="kSystem">
            <option>Doppelstab</option>
            <option>Holz</option>
            <option>WPC</option>
            <option>Alu</option>
            <option>Diagonalgeflecht</option>
            <option>Tornado</option>
            <option>Elektrozaun</option>
          </select>
        </div>
        <div>
          <label>Farbe</label>
          <select id="kColor"></select>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Holzart</label>
          <select id="kWood"></select>
        </div>
        <div>
          <label>WPC Variante</label>
          <select id="kWpc"></select>
        </div>
      </div>

      <div class="grid3">
        <div>
          <label>Gef√§lle</label>
          <select id="kSlopeType">
            <option value="flat">kein</option>
            <option value="pct">%</option>
          </select>
        </div>
        <div>
          <label>Gef√§lle %</label>
          <input id="kSlopePct" inputmode="decimal" placeholder="z. B. 2,5" />
        </div>
        <div>
          <label>Ecken</label>
          <div class="row">
            <button class="btn small" id="kCornersMinus" type="button">‚àí</button>
            <input id="kCorners" inputmode="numeric" value="0" style="max-width:140px;" />
            <button class="btn small" id="kCornersPlus" type="button">+</button>
          </div>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Beton‚ÄëModus</label>
          <select id="kConcreteMode">
            <option value="sacks">Sack (Auto)</option>
            <option value="m3">m¬≥ (Auto)</option>
          </select>
          <div class="hint" id="kConcreteAutoHint" style="margin-top:6px;"></div>
        </div>
        <div>
          <label>Beton (Auto)</label>
          <input id="kConcreteVal" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Sichtschutz?</label>
          <select id="kPrivacy">
            <option value="no">nein</option>
            <option value="yes">ja</option>
          </select>
        </div>
        <div>
          <label>Sichtschutz‚ÄëL√§nge (m)</label>
          <input id="kPrivacyLen" inputmode="decimal" placeholder="leer = ganze Zaunl√§nge" />
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="grid2">
          <div>
            <label>Tor‚ÄëTyp</label>
            <select id="kGateType">
              <option value="none">kein Tor</option>
              <option value="single">Einzeltor</option>
              <option value="double">Doppeltor</option>
              <option value="custom">Sonder</option>
            </select>
          </div>
          <div class="row" style="align-self:end;">
            <button class="btn small" id="btnGateAdd" type="button">+ Tor</button>
            <button class="btn small bad" id="btnGateClear" type="button">Tore l√∂schen</button>
          </div>
        </div>
        <div id="gateVariants" class="hint" style="margin-top:10px;"></div>
        <div id="gateRows" style="margin-top:10px;"></div>
      </div>

      <label>Kunden‚ÄëNotiz</label>
      <textarea id="kNote" placeholder="Notizen‚Ä¶"></textarea>

      <div class="row" style="margin-top:10px;">
        <button class="btn good dark" id="btnKCalc" type="button">Material berechnen ‚Üí Chef</button>
        <button class="btn blue" id="btnKDown" type="button">Kunden‚ÄëText Download</button>
        <button class="btn accent green" id="btnKWhats" type="button">WhatsApp Kunde</button>
        <button class="btn orange" id="btnKCall" type="button">üìû</button>
        <button class="btn purple" id="btnKMail" type="button">‚úâÔ∏è</button>
      </div>
    
      </div>
    </section>

    <!-- CHEF / TEAM -->
    <section class="panel tab" data-tab="chef" style="display:none;">
      <div class="cardTitle">
        <h2 id="chefTitle">üõ†Ô∏è Chef / Team</h2>
        <span class="pill" id="chefPill">leer</span>
      </div>

      <div class="grid3">
        <div>
          <label>Bagger</label>
          <select id="cBagger">
            <option value="no">nein</option>
            <option value="yes">ja</option>
          </select>
        </div>
        <div>
          <label>Ramme</label>
          <select id="cRamme">
            <option value="no">nein</option>
            <option value="yes">ja</option>
          </select>
        </div>
        <div>
          <label>H√§nger</label>
          <select id="cHaenger">
            <option value="no">nein</option>
            <option value="yes">ja</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Handbohrger√§t</label>
          <select id="cHandbohr">
            <option value="no">nein</option>
            <option value="yes">ja</option>
          </select>
        </div>
        <div>
          <label>Schubkarre</label>
          <select id="cSchubkarre">
            <option value="no">nein</option>
            <option value="yes">ja</option>
          </select>
        </div>
      </div>

      <label>Kunden‚ÄëNotiz (automatisch)</label>
      <textarea id="cCustomerNote" readonly placeholder="(wird aus dem Kunden‚ÄëTab √ºbernommen)"></textarea>

      <label>Team‚ÄëHinweise</label>
      <textarea id="cNote" placeholder="z. B. Zufahrt, Besonderheiten‚Ä¶"></textarea>

      <div class="card">
        <div class="cardTitle">
          <b>Interne Materialliste</b>
          <span class="pill" id="matPill">0</span>
        </div>

        <div class="grid3" style="margin-top:10px;">
          <div>
            <label>Material</label>
            <select id="mName">
              <optgroup label="Matten / Elemente">
                <option>Doppelstabmatte</option>
                <option>Diagonalgeflecht</option>
                <option>Tornado</option>
                <option>Elektrozaun</option>
              </optgroup>
              <optgroup label="Pfosten">
                <option>Pfosten</option>
                <option>Eckpfosten</option>
              </optgroup>
              <optgroup label="Leisten / Zubeh√∂r">
                <option>U-Leiste</option>
                <option>Torleiste</option>
                <option>Abdeckkappe</option>
              </optgroup>
              <optgroup label="Beton">
                <option>Beton (Sack)</option>
                <option>Fertigbeton (m¬≥)</option>
              </optgroup>
              <optgroup label="Sonstiges">
                <option value="__custom__">Sonstiges (Freitext)‚Ä¶</option>
              </optgroup>
            </select>
            <input id="mNameCustom" placeholder="Material frei eingeben‚Ä¶" style="display:none; margin-top:8px;" />
          </div>
          <div>
            <label>Menge</label>
            <input id="mQty" inputmode="decimal" />
          </div>
          <div>
            <label>Einheit</label>
            <select id="mUnit">
              <option>Stk</option>
              <option>m</option>
              <option>m¬≤</option>
              <option>Sack</option>
              <option>m¬≥</option>
              <option>Paket</option>
            </select>
          </div>
        </div>
<div class="row" style="margin-top:10px;">
          <button class="btn good" id="btnAddMat" type="button">+ hinzuf√ºgen</button>
          <button class="btn bad" id="btnClearMat" type="button">Liste leeren</button>
        </div>

        <div id="matList" style="margin-top:10px;"></div>
      </div>

      <div class="card">
        <div class="cardTitle">
          <b>Fotos</b>
          <span class="pill" id="photoPill">0</span>
        </div>
        <div class="hint" style="margin:8px 0 10px;">
          Desktop‚ÄëWhatsApp kann Fotos nicht automatisch anh√§ngen ‚Üí nutze ‚ÄûFotos.zip‚Äú.
        </div>
        <div id="photoGrid"></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn accent green" id="btnCWhats" type="button">WhatsApp Intern</button>
        <button class="btn blue" id="btnCDown" type="button">Intern‚ÄëText Download</button>
        <button class="btn blue" id="btnCZip" type="button">Fotos.zip</button>
        <button class="btn purple" id="btnCMail" type="button">E‚ÄëMail (Text)</button>
      </div>
    </section>

  </div>

  <div id="toast"></div>

  <datalist id="gateWidthList">
    <option value="80"></option>
    <option value="100"></option>
    <option value="125"></option>
    <option value="150"></option>
    <option value="200"></option>
  </datalist>

  <script src="./app.js" defer></script></script>
<!-- PWA Service Worker (Auto-Update) -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", async () => {
        try {
          const reg = await navigator.serviceWorker.register("./sw.js", { updateViaCache: "none" });

          const doUpdate = () => reg.update().catch(()=>{});
          doUpdate();
          setInterval(doUpdate, 15*60*1000);

          if (reg.waiting) reg.waiting.postMessage({ type: "SKIP_WAITING" });

          reg.addEventListener("updatefound", () => {
            const sw = reg.installing;
            if (!sw) return;
            sw.addEventListener("statechange", () => {
              if (sw.state === "installed" && navigator.serviceWorker.controller) {
                if (reg.waiting) reg.waiting.postMessage({ type: "SKIP_WAITING" });
              }
            });
          });

          navigator.serviceWorker.addEventListener("controllerchange", () => {
            location.reload();
          });
        } catch (e) {
          console.warn("SW register failed", e);
        }
      });
    }
  </script>
</body>
</html>
